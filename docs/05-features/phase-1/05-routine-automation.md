# Phase 1-5: ë£¨í‹´ ìë™í™” (Routine Automation)

> **Phase**: 1 (MVP)  
> **ì¹´í…Œê³ ë¦¬**: ë£¨í‹´ & ì•Œë¦¼  
> **ìš°ì„ ìˆœìœ„**: ğŸ”´ í•„ìˆ˜  
> **ì£¼ì°¨**: Week 6 (6ì£¼ì°¨)

---

## ğŸ“‹ ê¸°ëŠ¥ ê°œìš”

ë§¤ì¼ ë°˜ë³µë˜ëŠ” ë£¨í‹´ì„ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê³ , ë¯¸ì™„ë£Œ í•­ëª©ì— ëŒ€í•´ ìì •ì— ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### í•µì‹¬ íŠ¹ì§•

1. **ë§¤ì¼ ìë™ ìƒì„±**: Vercel Cronìœ¼ë¡œ ì •ì‹œì— ë£¨í‹´ ìë™ ìƒì„±
2. **ë£¨í‹´ on/off**: ë£¨í‹´ í™œì„±í™”/ë¹„í™œì„±í™” ê°„í¸ í† ê¸€
3. **ì™„ë£Œìœ¨ ê¸°ë¡**: ë£¨í‹´ ë‹¬ì„± ì—¬ë¶€ ì €ì¥ (íˆíŠ¸ë§µìš©)
4. **ìì • ì•Œë¦¼**: ë¯¸ì™„ë£Œ í•­ëª© ì•Œë¦¼
5. **ì¼ê´„ ì´ë™**: ë¯¸ì™„ë£Œ í•­ëª© ì˜¤ëŠ˜ë¡œ ì´ë™ ë²„íŠ¼

---

## ğŸ¯ ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ë£¨í‹´ ìƒì„±í•˜ê¸°
```
1. ì¢Œì¸¡ + ë²„íŠ¼ ë˜ëŠ” ì„¤ì • > "ë£¨í‹´ ì¶”ê°€"
2. ë£¨í‹´ ì…ë ¥:
   - ì´ë¦„: "ì•„ì¹¨ ìš´ë™"
   - ì‹œê°„: 07:00 (ë§¤ì¼)
   - ë°˜ë³µ: ì›”-ê¸ˆ (ì„ íƒ)
3. ì €ì¥ â†’ ë‚´ì¼ë¶€í„° ìë™ ìƒì„±
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë§¤ì¼ ë£¨í‹´ ìë™ ìƒì„±
```
1. ë§¤ì¼ ìì • (00:00) ë˜ëŠ” ì„¤ì • ì‹œê°„ì— ì‹¤í–‰
2. í™œì„±í™”ëœ ëª¨ë“  ë£¨í‹´ ìë™ ìƒì„±
3. ì‚¬ìš©ìê°€ ì•± ì¼¤ ë•Œ ì¦‰ì‹œ í‘œì‹œ
4. ì˜ˆ: 7ì‹œ "ì•„ì¹¨ ìš´ë™"ì´ í• ì¼ ë¦¬ìŠ¤íŠ¸ì— ë‚˜íƒ€ë‚¨
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë£¨í‹´ ì™„ë£Œ ê¸°ë¡
```
1. ë£¨í‹´ í• ì¼ "ì•„ì¹¨ ìš´ë™" ì²´í¬
2. ì™„ë£Œ ì‹œê°„ ê¸°ë¡ (ì¼ë³„ í†µê³„ìš©)
3. íˆíŠ¸ë§µì— í‘œì‹œ (ë‚˜ì¤‘ì— ëŒ€ì‹œë³´ë“œì—ì„œ)
```

### ì‹œë‚˜ë¦¬ì˜¤ 4: ë¯¸ì™„ë£Œ ì•Œë¦¼ (ìì •)
```
1. ì–´ì œ ë¯¸ì™„ë£Œ í•­ëª© ê°ì§€
   - "í”„ë¡œì íŠ¸ A ë§ˆë¬´ë¦¬"
   - "íšŒì˜ ë³´ê³ ì„œ"
2. ìì •(00:00)ì— ì´ë©”ì¼ ë˜ëŠ” ë¸Œë¼ìš°ì € ì•Œë¦¼
   "ì–´ì œ ì™„ë£Œí•˜ì§€ ëª»í•œ í• ì¼ì´ 2ê°œ ìˆìŠµë‹ˆë‹¤"
3. "ì˜¤ëŠ˜ë¡œ ì´ë™" ë²„íŠ¼ ì œê³µ
```

### ì‹œë‚˜ë¦¬ì˜¤ 5: ë¯¸ì™„ë£Œ í•­ëª© ì¼ê´„ ì´ë™
```
1. ì•±ì—ì„œ "ë¯¸ì™„ë£Œ í•­ëª© ì´ë™" ë²„íŠ¼ (ìˆ˜ë™ í˜¸ì¶œ)
2. ë˜ëŠ” ìì • ì•Œë¦¼ì—ì„œ "ì˜¤ëŠ˜ë¡œ ì´ë™" í´ë¦­
3. ì–´ì œ ë¯¸ì™„ë£Œ í•­ëª©ë“¤ì„ ì˜¤ëŠ˜ë¡œ ìë™ ì´ë™
```

---

## ğŸ—„ï¸ ë°ì´í„° ëª¨ë¸

### Routine í…Œì´ë¸”

```prisma
model Routine {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  title     String
  time      String   @default("09:00") // HH:mm í˜•ì‹
  
  // ë°˜ë³µ ì„¤ì •
  isActive  Boolean  @default(true)
  daysOfWeek String  @default("1,2,3,4,5") // 1=ì›”, 7=ì¼ (JSON ë°°ì—´ë¡œ ì €ì¥ ê°€ëŠ¥)
  
  // ë§¤ ì¼ë§ˆë‹¤ ìƒì„±ëœ í• ì¼
  todos     Todo[]   @relation("RoutineTodos")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RoutineComplete {
  id        String   @id @default(cuid())
  userId    String
  routineId String
  routine   Routine  @relation(fields: [routineId], references: [id])
  
  completedDate DateTime // ë‚ ì§œë§Œ (ì‹œê°„ ì œê±°)
  completed Boolean     @default(false)
  completedAt   DateTime?
  
  createdAt DateTime @default(now())
  
  @@unique([routineId, completedDate])
}

model Todo {
  // ... ê¸°ì¡´ í•„ë“œ
  routineId String?
  isFromRoutine Boolean @default(false) // ë£¨í‹´ì—ì„œ ìƒì„±ëœ í•­ëª©ì¸ì§€ ì—¬ë¶€
}
```

---

## ğŸ’» êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### Vercel Cron Job

```typescript
// app/api/cron/generate-routines/route.ts
import { NextRequest } from 'next/server'

export async function GET(req: NextRequest) {
  // 1. Vercel í¬ë¡  ê²€ì¦
  if (req.headers.get('authorization') !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 })
  }

  try {
    await generateDailyRoutines()
    return new Response(JSON.stringify({ success: true }), { status: 200 })
  } catch (error) {
    console.error('Cron job error:', error)
    return new Response(JSON.stringify({ error: error.message }), { status: 500 })
  }
}

// vercel.json
{
  "crons": [{
    "path": "/api/cron/generate-routines",
    "schedule": "0 0 * * *"  // ë§¤ì¼ ìì •
  }]
}
```

### ë£¨í‹´ ìë™ ìƒì„± ë¡œì§

```typescript
// app/actions/routine-actions.ts
'use server'

export async function generateDailyRoutines(): Promise<void> {
  // 1. ëª¨ë“  í™œì„± ë£¨í‹´ ì¡°íšŒ
  const routines = await prisma.routine.findMany({
    where: { isActive: true },
  })

  const today = new Date()
  today.setHours(0, 0, 0, 0)
  const dayOfWeek = today.getDay() // 0=ì¼, 1=ì›”, ..., 6=í† 

  for (const routine of routines) {
    // 2. ì˜¤ëŠ˜ì´ ë£¨í‹´ ë°˜ë³µì¼ì¸ì§€ í™•ì¸
    const daysOfWeek = routine.daysOfWeek.split(',').map(d => parseInt(d))
    const normalizedDay = dayOfWeek === 0 ? 7 : dayOfWeek // 1=ì›”, 7=ì¼
    
    if (!daysOfWeek.includes(normalizedDay)) continue

    // 3. ì´ë¯¸ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
    const existing = await prisma.routineComplete.findUnique({
      where: {
        routineId_completedDate: {
          routineId: routine.id,
          completedDate: today,
        },
      },
    })

    if (existing) continue

    // 4. ë£¨í‹´ í• ì¼ ìƒì„±
    const [hours, minutes] = routine.time.split(':').map(Number)
    const scheduledTime = new Date(today)
    scheduledTime.setHours(hours, minutes, 0, 0)

    const todo = await prisma.todo.create({
      data: {
        userId: routine.userId,
        title: routine.title,
        routineId: routine.id,
        isFromRoutine: true,
        estimatedMin: 60, // ê¸°ë³¸ê°’
        categoryId: null, // ë˜ëŠ” ê¸°ë³¸ ì¹´í…Œê³ ë¦¬
      },
    })

    // 5. RoutineComplete ê¸°ë¡
    await prisma.routineComplete.create({
      data: {
        userId: routine.userId,
        routineId: routine.id,
        completedDate: today,
      },
    })
  }

  // 6. ë¯¸ì™„ë£Œ ì•Œë¦¼ ë°œì†¡
  await sendMidnightNotifications()
}
```

### ë¯¸ì™„ë£Œ ì•Œë¦¼

```typescript
// lib/notifications.ts

export async function sendMidnightNotifications(): Promise<void> {
  const yesterday = new Date()
  yesterday.setDate(yesterday.getDate() - 1)
  yesterday.setHours(0, 0, 0, 0)

  const today = new Date()
  today.setHours(0, 0, 0, 0)

  // 1. ì–´ì œ ë¯¸ì™„ë£Œ í• ì¼ ì°¾ê¸°
  const incompleteTodos = await prisma.todo.findMany({
    where: {
      completed: false,
      createdAt: {
        gte: yesterday,
        lt: today,
      },
    },
    include: { user: true },
    distinct: ['userId'],
  })

  // 2. ì‚¬ìš©ìë³„ë¡œ ê·¸ë£¹í™”
  const userTodoMap = new Map<string, number>()
  for (const todo of incompleteTodos) {
    const count = userTodoMap.get(todo.userId) || 0
    userTodoMap.set(todo.userId, count + 1)
  }

  // 3. ê° ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë°œì†¡
  for (const [userId, count] of userTodoMap) {
    const user = await prisma.user.findUnique({ where: { id: userId } })
    if (user?.email) {
      await sendEmail({
        to: user.email,
        subject: `Todal: ì–´ì œ ë¯¸ì™„ë£Œ í•­ëª© ${count}ê°œ`,
        template: 'incomplete-reminder',
        data: { count, userName: user.name },
      })
    }
  }
}
```

### ë£¨í‹´ on/off í† ê¸€

```typescript
export async function toggleRoutine(
  routineId: string,
  isActive: boolean
): Promise<Routine> {
  return prisma.routine.update({
    where: { id: routineId },
    data: { isActive },
  })
}

// UIì—ì„œ
// <ToggleSwitch
//   checked={routine.isActive}
//   onChange={(checked) => toggleRoutine(routine.id, checked)}
// />
```

### ë¯¸ì™„ë£Œ í•­ëª© ì¼ê´„ ì´ë™

```typescript
export async function moveIncompleteTodaysToday(
  userId: string
): Promise<number> {
  const yesterday = new Date()
  yesterday.setDate(yesterday.getDate() - 1)
  yesterday.setHours(0, 0, 0, 0)

  const result = await prisma.todo.updateMany({
    where: {
      userId,
      completed: false,
      createdAt: {
        gte: new Date(yesterday.getTime() - 24 * 60 * 60 * 1000), // ë²”ìœ„ í™•ì¥
        lt: yesterday,
      },
    },
    data: {
      createdAt: new Date(), // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë³€ê²½
    },
  })

  return result.count
}
```

---

## ğŸ¨ UI êµ¬í˜„

### ë£¨í‹´ ì„¤ì • UI

```tsx
// components/routine/routine-settings.tsx
'use client'

export function RoutineSettings() {
  const [routines, setRoutines] = useState<Routine[]>([])
  const [isOpen, setIsOpen] = useState(false)

  return (
    <div>
      {/* ë£¨í‹´ ëª©ë¡ */}
      <div className="space-y-2">
        {routines.map(routine => (
          <div key={routine.id} className="flex items-center justify-between p-3">
            <div>
              <p className="font-medium">{routine.title}</p>
              <p className="text-sm text-gray-500">{routine.time}</p>
            </div>
            <Toggle
              checked={routine.isActive}
              onChange={(checked) => toggleRoutine(routine.id, checked)}
            />
          </div>
        ))}
      </div>

      {/* ë£¨í‹´ ì¶”ê°€ ë²„íŠ¼ */}
      <Button onClick={() => setIsOpen(true)}>+ ë£¨í‹´ ì¶”ê°€</Button>

      {/* ë£¨í‹´ ìƒì„± ë‹¤ì´ì–¼ë¡œê·¸ */}
      {isOpen && <RoutineDialog onClose={() => setIsOpen(false)} />}
    </div>
  )
}
```

### ë¯¸ì™„ë£Œ ì•Œë¦¼ ë°°ë„ˆ

```tsx
// components/incomplete-reminder.tsx
'use client'

export function IncompleteReminder({ count }: { count: number }) {
  if (count === 0) return null

  return (
    <div className="bg-orange-50 border-l-4 border-orange-400 p-4">
      <div className="flex items-center justify-between">
        <p className="text-orange-800">
          ì–´ì œ ì™„ë£Œí•˜ì§€ ëª»í•œ í• ì¼ì´ {count}ê°œ ìˆìŠµë‹ˆë‹¤
        </p>
        <Button
          size="sm"
          onClick={() => moveIncompleteToday()}
        >
          ì˜¤ëŠ˜ë¡œ ì´ë™
        </Button>
      </div>
    </div>
  )
}
```

---

## âœ… ì™„ë£Œ ê¸°ì¤€

- [ ] Routine ëª¨ë¸ DB ì €ì¥ ê°€ëŠ¥
- [ ] Vercel Cron Job ì„¤ì •
- [ ] ë§¤ì¼ ìì •ì— ë£¨í‹´ ìë™ ìƒì„±
- [ ] ë£¨í‹´ on/off í† ê¸€ ì‘ë™
- [ ] RoutineComplete ê¸°ë¡ ì €ì¥
- [ ] ë¯¸ì™„ë£Œ í•­ëª© ê°ì§€
- [ ] ìì • ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
- [ ] ë¯¸ì™„ë£Œ í•­ëª© ì¼ê´„ ì´ë™
- [ ] ë£¨í‹´ ì„¤ì • UI
- [ ] ì•Œë¦¼ ë°°ë„ˆ í‘œì‹œ

---

## ğŸ“Œ ì—°ê´€ ê¸°ëŠ¥

- Phase 2: ë£¨í‹´ íˆíŠ¸ë§µ (ëŒ€ì‹œë³´ë“œ)

---

**Last Updated**: 2025-10-17
